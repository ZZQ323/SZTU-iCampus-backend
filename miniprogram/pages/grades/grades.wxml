<!-- 成绩查询页面 -->
<view class="page">
  <!-- 自定义导航栏 -->
  <custom-navbar title="成绩查询" showBack="{{true}}"></custom-navbar>
  
  <!-- 学期选择器 -->
  <view class="semester-selector">
    <view class="semester-info">
      <text class="current-semester">{{gradesData.semester_info.academic_year}}</text>
      <text class="semester-name">第{{gradesData.semester_info.current_semester}}学期</text>
    </view>
    <view class="semester-picker">
      <picker 
        range="{{semesterRange}}" 
        range-key="label" 
        value="{{semesterIndex}}" 
        bindchange="onSemesterChange"
      >
        <view class="picker-btn">
          <text>切换学期</text>
          <image src="/assets/icons/arrow-down.png" class="arrow-icon"></image>
        </view>
      </picker>
    </view>
  </view>

  <!-- 成绩汇总卡片 -->
  <view class="summary-card">
    <view class="summary-title">学期成绩概览</view>
    <view class="summary-grid">
      <view class="summary-item">
        <text class="summary-value">{{gradesData.summary.total_courses}}</text>
        <text class="summary-label">总课程数</text>
      </view>
      <view class="summary-item">
        <text class="summary-value">{{gradesData.summary.total_credits}}</text>
        <text class="summary-label">总学分</text>
      </view>
      <view class="summary-item">
        <text class="summary-value">{{gradesData.summary.avg_score}}</text>
        <text class="summary-label">平均分</text>
      </view>
      <view class="summary-item">
        <text class="summary-value">{{gradesData.summary.gpa}}</text>
        <text class="summary-label">GPA</text>
      </view>
    </view>
    <view class="ranking-info">
      <text class="rank-text">班级排名：第{{gradesData.summary.rank}}名 / 共{{gradesData.summary.total_students}}人</text>
    </view>
  </view>

  <!-- 筛选选项 -->
  <view class="filter-section">
    <view class="filter-tabs">
      <view 
        class="filter-tab {{currentFilter === 'all' ? 'active' : ''}}"
        bindtap="setFilter"
        data-filter="all"
      >
        全部
      </view>
      <view 
        class="filter-tab {{currentFilter === '必修' ? 'active' : ''}}"
        bindtap="setFilter"
        data-filter="必修"
      >
        必修课
      </view>
      <view 
        class="filter-tab {{currentFilter === '选修' ? 'active' : ''}}"
        bindtap="setFilter"
        data-filter="选修"
      >
        选修课
      </view>
      <view 
        class="filter-tab {{currentFilter === '实践' ? 'active' : ''}}"
        bindtap="setFilter"
        data-filter="实践"
      >
        实践课
      </view>
    </view>
  </view>

  <!-- 成绩列表 -->
  <view class="grades-list">
    <view 
      class="grade-item {{item.grade_level}}"
      wx:for="{{filteredGrades}}" 
      wx:key="id"
      bindtap="showGradeDetail"
      data-grade="{{item}}"
    >
      <view class="grade-header">
        <view class="course-info">
          <text class="course-name">{{item.course_name}}</text>
          <text class="course-code">{{item.course_code}}</text>
        </view>
        <view class="grade-score">
          <text class="total-score">{{item.total_score}}</text>
          <text class="grade-level">{{item.grade_level}}</text>
        </view>
      </view>
      
      <view class="grade-details">
        <view class="detail-row">
          <text class="detail-label">授课教师：</text>
          <text class="detail-value">{{item.teacher}}</text>
          <text class="detail-label">学分：</text>
          <text class="detail-value">{{item.credits}}</text>
        </view>
        <view class="detail-row">
          <text class="detail-label">课程类型：</text>
          <text class="detail-value course-type">{{item.course_type}}</text>
          <text class="detail-label">绩点：</text>
          <text class="detail-value gpa-points">{{item.gpa_points}}</text>
        </view>
      </view>
      
      <!-- 成绩构成进度条 -->
      <view class="score-breakdown">
        <view class="breakdown-item">
          <text class="breakdown-label">平时：{{item.regular_score}}</text>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{item.regular_score}}%"></view>
          </view>
        </view>
        <view class="breakdown-item">
          <text class="breakdown-label">期中：{{item.midterm_score}}</text>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{item.midterm_score}}%"></view>
          </view>
        </view>
        <view class="breakdown-item">
          <text class="breakdown-label">期末：{{item.final_score}}</text>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{item.final_score}}%"></view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-grades" wx:if="{{filteredGrades.length === 0}}">
    <image src="/assets/icons/Grade.png" class="empty-icon"></image>
    <text class="empty-text">暂无成绩数据</text>
    <text class="empty-tip">请选择其他学期或联系教务处</text>
  </view>

  <!-- 底部安全距离 -->
  <view class="safe-area-bottom"></view>
</view>

<!-- 成绩详情弹窗 -->
<view class="grade-modal {{showModal ? 'show' : ''}}" bindtap="hideModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">{{modalData.course_name}}</text>
      <view class="modal-close" bindtap="hideModal">×</view>
    </view>
    <view class="modal-body">
      <view class="modal-score-display">
        <view class="main-score">
          <text class="score-number">{{modalData.total_score}}</text>
          <text class="score-level">{{modalData.grade_level}}</text>
        </view>
        <view class="score-details">
          <view class="score-item">
            <text class="score-label">平时成绩</text>
            <text class="score-value">{{modalData.regular_score}}分</text>
          </view>
          <view class="score-item">
            <text class="score-label">期中成绩</text>
            <text class="score-value">{{modalData.midterm_score}}分</text>
          </view>
          <view class="score-item">
            <text class="score-label">期末成绩</text>
            <text class="score-value">{{modalData.final_score}}分</text>
          </view>
        </view>
      </view>
      
      <view class="modal-info">
        <view class="info-item">
          <text class="info-label">课程代码</text>
          <text class="info-value">{{modalData.course_code}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">授课教师</text>
          <text class="info-value">{{modalData.teacher}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">学分</text>
          <text class="info-value">{{modalData.credits}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">课程类型</text>
          <text class="info-value">{{modalData.course_type}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">绩点</text>
          <text class="info-value">{{modalData.gpa_points}}</text>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn" bindtap="hideModal">关闭</button>
    </view>
  </view>
</view> 