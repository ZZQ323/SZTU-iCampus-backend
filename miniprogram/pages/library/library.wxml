<view class="container">
  <custom-navbar 
    title="å›¾ä¹¦é¦†" 
    background="#4a90e2"
    color="#ffffff"
  />
  
  <view class="library-container">
    <!-- å›¾ä¹¦é¦†æ¦‚è§ˆå¡ç‰‡ -->
    <view class="overview-card">
      <view class="overview-header">
        <view class="overview-title">ğŸ“Š ä»Šæ—¥æ¦‚è§ˆ</view>
        <view class="overview-time">{{todayCheckInCount}} äººå·²è¿›é¦†</view>
      </view>
      <view class="overview-stats">
        <view class="stat-item">
          <view class="stat-number">{{availableSeats}}</view>
          <view class="stat-label">å¯ç”¨åº§ä½</view>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <view class="stat-number">{{currentBorrow}}/{{maxBorrow}}</view>
          <view class="stat-label">å€Ÿé˜…æ•°é‡</view>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <view class="stat-number" wx:if="{{overdueBooksCount > 0}}" style="color: #e34d59;">{{overdueBooksCount}}</view>
          <view class="stat-number" wx:else style="color: #00a870;">0</view>
          <view class="stat-label">é€¾æœŸå›¾ä¹¦</view>
        </view>
      </view>
    </view>

    <!-- å…¬å‘Šæ  -->
    <view class="announcement-bar" wx:if="{{announcements.length > 0}}">
      <t-icon name="notification" size="16" color="#0052d9" />
      <view class="announcement-text">{{announcements[0].title}}</view>
    </view>

    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <t-tabs value="{{activeTab}}" bind:change="onTabChange" sticky sticky-offset="{{0}}">
      <t-tab-panel label="ğŸ“– å€Ÿé˜…" value="borrow">
        <!-- å€Ÿé˜…ä¿¡æ¯åŒºåŸŸ -->
        <view class="borrow-section">
          <!-- å½“å‰å€Ÿé˜… -->
          <view class="section-header">
            <view class="section-title">å½“å‰å€Ÿé˜… ({{currentBorrow}}/{{maxBorrow}})</view>
            <view class="section-action" bindtap="refreshBorrowInfo">
              <t-icon name="refresh" size="16" color="#0052d9" />
              <text>åˆ·æ–°</text>
            </view>
          </view>

          <view wx:if="{{loading}}" class="loading-container">
            <t-loading size="24" />
            <text>åŠ è½½ä¸­...</text>
          </view>

          <view wx:elif="{{borrowList.length === 0}}" class="empty-state">
            <t-icon name="book" size="48" color="#ccc" />
            <view class="empty-text">æš‚æ— å€Ÿé˜…å›¾ä¹¦</view>
            <view class="empty-subtitle">å»æœç´¢é¡µé¢æ‰¾æ‰¾å–œæ¬¢çš„ä¹¦å§</view>
          </view>

          <view wx:else>
            <view class="book-item" wx:for="{{borrowList}}" wx:key="id">
              <view class="book-cover">
                <image src="{{item.cover}}" mode="aspectFit" />
                <view wx:if="{{item.isOverdue}}" class="overdue-badge">é€¾æœŸ</view>
              </view>
              <view class="book-info">
                <view class="book-title">{{item.title}}</view>
                <view class="book-author">{{item.author}}</view>
                <view class="book-meta">
                  <view class="meta-item">
                    <text>å€Ÿé˜…ï¼š{{item.borrowDate}}</text>
                  </view>
                  <view class="meta-item">
                    <text>åˆ°æœŸï¼š{{item.dueDate}}</text>
                  </view>
                  <view class="meta-item" wx:if="{{item.isOverdue}}">
                    <text style="color: #e34d59;">å·²é€¾æœŸ {{-item.daysLeft}} å¤©</text>
                  </view>
                  <view class="meta-item" wx:else>
                    <text style="color: {{item.daysLeft <= 3 ? '#ff9500' : '#00a870'}};">
                      è¿˜æœ‰ {{item.daysLeft}} å¤©åˆ°æœŸ
                    </text>
                  </view>
                </view>
                <view class="book-actions">
                  <t-button size="small" theme="light" data-book="{{item}}" bindtap="renewBook" 
                    disabled="{{item.renewCount >= item.maxRenew}}">
                    ç»­å€Ÿ ({{item.renewCount}}/{{item.maxRenew}})
                  </t-button>
                  <t-button size="small" theme="outline" data-book="{{item}}" bindtap="onViewBookDetail">
                    è¯¦æƒ…
                  </t-button>
                </view>
              </view>
            </view>
          </view>

          <!-- å€Ÿé˜…å†å² -->
          <view class="section-header" style="margin-top: 24px;">
            <view class="section-title">å€Ÿé˜…å†å²</view>
          </view>
          <view class="history-list">
            <view class="history-item" wx:for="{{borrowHistory}}" wx:key="id">
              <view class="history-info">
                <view class="history-title">{{item.title}}</view>
                <view class="history-meta">{{item.borrowDate}} - {{item.returnDate}}</view>
              </view>
              <view class="history-rating">
                <t-rate value="{{item.rating}}" size="14" disabled />
              </view>
            </view>
          </view>
        </view>
      </t-tab-panel>

      <t-tab-panel label="ğŸ” æœç´¢" value="search">
        <!-- æœç´¢åŒºåŸŸ -->
        <view class="search-section">
          <view class="search-bar">
            <t-input 
              value="{{searchKeyword}}" 
              placeholder="æœç´¢å›¾ä¹¦ã€ä½œè€…ã€ISBN..."
              prefix-icon="search"
              bind:input="onSearchInput"
              bind:confirm="onSearch"
              confirm-type="search"
            />
            <t-button theme="primary" size="small" bindtap="onSearch">æœç´¢</t-button>
          </view>

          <!-- æœç´¢ç»“æœ -->
          <view wx:if="{{showSearchResults}}" class="search-results">
            <view class="section-header">
              <view class="section-title">æœç´¢ç»“æœ ({{searchResults.length}})</view>
            </view>
            <view class="book-grid">
              <view class="book-card" wx:for="{{searchResults}}" wx:key="id" data-book="{{item}}" bindtap="onViewBookDetail">
                <view class="book-cover">
                  <image src="{{item.cover}}" mode="aspectFit" />
                  <view class="book-status {{item.status === 'available' ? 'available' : 'borrowed'}}">
                    {{item.status === 'available' ? 'å¯å€Ÿ' : 'å·²å€Ÿ'}}
                  </view>
                </view>
                <view class="book-details">
                  <view class="book-title">{{item.title}}</view>
                  <view class="book-author">{{item.author}}</view>
                  <view class="book-location">{{item.location}}</view>
                  <view class="book-stats">
                    <view class="rating">
                      <t-rate value="{{item.rating}}" size="12" disabled />
                      <text class="rating-text">{{item.rating}}</text>
                    </view>
                    <view class="borrow-count">å€Ÿé˜… {{item.borrowCount}} æ¬¡</view>
                  </view>
                  <view class="book-actions">
                    <t-button size="small" theme="primary" wx:if="{{item.status === 'available'}}">
                      å€Ÿé˜…
                    </t-button>
                    <t-button size="small" theme="light" wx:else data-book="{{item}}" bindtap="reserveBook">
                      é¢„çº¦
                    </t-button>
                  </view>
                </view>
              </view>
            </view>
          </view>

          <!-- çƒ­é—¨å›¾ä¹¦ -->
          <view wx:else>
            <view class="section-header">
              <view class="section-title">ğŸ”¥ çƒ­é—¨å›¾ä¹¦</view>
            </view>
            <view class="book-grid">
              <view class="book-card" wx:for="{{popularBooks}}" wx:key="id" data-book="{{item}}" bindtap="onViewBookDetail">
                <view class="book-cover">
                  <image src="{{item.cover}}" mode="aspectFit" />
                  <view class="book-status {{item.status === 'available' ? 'available' : 'borrowed'}}">
                    {{item.status === 'available' ? 'å¯å€Ÿ' : 'å·²å€Ÿ'}}
                  </view>
                </view>
                <view class="book-details">
                  <view class="book-title">{{item.title}}</view>
                  <view class="book-author">{{item.author}}</view>
                  <view class="book-stats">
                    <view class="rating">
                      <t-rate value="{{item.rating}}" size="12" disabled />
                    </view>
                    <view class="borrow-count">{{item.borrowCount}} æ¬¡å€Ÿé˜…</view>
                  </view>
                </view>
              </view>
            </view>

            <!-- æ–°ä¹¦æ¨è -->
            <view class="section-header" style="margin-top: 24px;">
              <view class="section-title">ğŸ“š æ–°ä¹¦æ¨è</view>
            </view>
            <view class="new-books-list">
              <view class="new-book-item" wx:for="{{newArrivals}}" wx:key="id" data-book="{{item}}" bindtap="onViewBookDetail">
                <view class="book-cover">
                  <image src="{{item.cover}}" mode="aspectFit" />
                  <view class="new-badge">NEW</view>
                </view>
                <view class="book-info">
                  <view class="book-title">{{item.title}}</view>
                  <view class="book-author">{{item.author}}</view>
                  <view class="arrival-date">{{item.arrivalDate}} æ–°åˆ°</view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </t-tab-panel>

      <t-tab-panel label="ğŸ’º åº§ä½" value="seat">
        <!-- åº§ä½é¢„çº¦åŒºåŸŸ -->
        <view class="seat-section">
          <view class="seat-overview">
            <view class="overview-title">ğŸ“ åº§ä½æ¦‚è§ˆ</view>
            <view class="seat-stats">
              <view class="seat-progress">
                <view class="progress-bar">
                  <view class="progress-fill" style="width: {{(totalSeats - availableSeats) / totalSeats * 100}}%;"></view>
                </view>
                <view class="progress-text">{{totalSeats - availableSeats}}/{{totalSeats}} å·²å ç”¨</view>
              </view>
            </view>
          </view>

          <view class="floors-list">
            <view class="floor-item" wx:for="{{floors}}" wx:key="id" data-floor="{{item}}" bindtap="onSelectFloor">
              <view class="floor-info">
                <view class="floor-name">{{item.name}}</view>
                <view class="floor-description">{{item.description}}</view>
                <view class="floor-stats">
                  <view class="available-seats">å¯ç”¨: {{item.availableSeats}} ä¸ª</view>
                  <view class="occupancy-rate">å ç”¨ç‡: {{item.occupancyRate}}%</view>
                </view>
              </view>
              <view class="floor-indicator">
                <view class="seats-circle {{item.availableSeats < 10 ? 'low' : item.availableSeats < 30 ? 'medium' : 'high'}}">
                  {{item.availableSeats}}
                </view>
                <t-icon name="chevron-right" size="16" color="#ccc" />
              </view>
            </view>
          </view>
        </view>
      </t-tab-panel>

      <t-tab-panel label="ğŸ’¡ èè´­" value="recommend">
        <!-- å›¾ä¹¦èè´­åŒºåŸŸ -->
        <view class="recommend-section">
          <view class="recommend-header">
            <view class="section-title">ğŸ“ å›¾ä¹¦èè´­</view>
            <view class="section-subtitle">æ¨èæ‚¨å¸Œæœ›å›¾ä¹¦é¦†è´­ä¹°çš„å›¾ä¹¦</view>
          </view>

          <view class="recommend-form">
            <t-textarea 
              value="{{recommendInfo}}"
              placeholder="è¯·è¾“å…¥å›¾ä¹¦åç§°ã€ä½œè€…ã€ISBNæˆ–ç›¸å…³ä¿¡æ¯..."
              maxlength="500"
              indicator
              bind:input="onRecommendInput"
            />
            <t-button theme="primary" block bindtap="onRecommend" disabled="{{!recommendInfo.trim()}}">
              æäº¤èè´­
            </t-button>
          </view>

          <!-- èè´­è¯´æ˜ -->
          <view class="recommend-tips">
            <view class="tips-title">ğŸ’¡ èè´­è¯´æ˜</view>
            <view class="tips-content">
              <view class="tip-item">â€¢ è¯·æä¾›å‡†ç¡®çš„å›¾ä¹¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¹¦åã€ä½œè€…ã€å‡ºç‰ˆç¤¾ç­‰</view>
              <view class="tip-item">â€¢ ä¼˜å…ˆè€ƒè™‘å­¦æœ¯ä»·å€¼é«˜ã€è¯»è€…éœ€æ±‚é‡å¤§çš„å›¾ä¹¦</view>
              <view class="tip-item">â€¢ èè´­ç»“æœå°†åœ¨7ä¸ªå·¥ä½œæ—¥å†…åé¦ˆ</view>
              <view class="tip-item">â€¢ å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»å›¾ä¹¦é¦†å’¨è¯¢å°</view>
            </view>
          </view>
        </view>
      </t-tab-panel>
    </t-tabs>
  </view>
</view> 