<navigation-bar title="SZTU iCampus" back="{{false}}" color="black" background="#FFFFFF"></navigation-bar>

<view class="index">
  <!-- ğŸŒŠ æµå¼è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
  <view class="stream-status {{streamStatus.isConnected ? 'connected' : 'disconnected'}}" bind:tap="testStreamConnection">
    <view class="status-indicator">
      <view class="status-dot {{streamStatus.isConnected ? 'active' : ''}}"></view>
      <text class="status-text">{{streamStatus.isConnected ? 'å®æ—¶è¿æ¥' : 'ç¦»çº¿æ¨¡å¼'}}</text>
    </view>
    <view class="status-detail" wx:if="{{streamStatus.isConnected}}">
      <text class="update-time">{{streamStatus.lastUpdate}}</text>
    </view>
  </view>

  <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
  <view class="user-card">
    <view class="user-avatar">
      <text class="user-icon">ğŸ‘‹</text>
    </view>
    <view class="user-info">
      <text class="user-name">{{userInfo.name}}</text>
      <text class="user-details">å­¦å·: {{userInfo.studentId}}</text>
      <text class="user-college">{{userInfo.college}}</text>
    </view>
    <view class="user-status">
      <view class="status-badge {{streamStatus.isConnected ? 'online' : 'offline'}}">
        {{streamStatus.isConnected ? 'åœ¨çº¿' : 'ç¦»çº¿'}}
      </view>
    </view>
  </view>

  <!-- å¿«æ·æœåŠ¡ç½‘æ ¼ -->
  <view class="services-section">
    <view class="section-header">
      <text class="section-title">ğŸŒŠ æ™ºèƒ½æœåŠ¡</text>
      <text class="section-subtitle">æµå¼æ•°æ®ï¼Œå®æ—¶ä½“éªŒ</text>
    </view>
    
    <view class="services-grid">
      <view class="service-item" wx:for="{{quickServices}}" wx:key="title" bind:tap="navigateTo{{item.title}}">
        <view class="service-icon">{{item.icon}}</view>
        <text class="service-title">{{item.title}}</text>
        <view class="service-indicator" wx:if="{{item.title === 'å…¬å‘Š' && newAnnouncementCount > 0}}">
          <text class="new-count">{{newAnnouncementCount}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å®æ—¶å…¬å‘Šæ¨é€åŒºåŸŸ -->
  <view class="announcements-section">
    <view class="section-header">
      <text class="section-title">ğŸ“¢ æ ¡å›­å…¬å‘Š</text>
      <view class="section-actions">
        <view class="stream-indicator {{streamStatus.isConnected ? 'streaming' : ''}}">
          <view class="stream-dot"></view>
          <text class="stream-text">{{streamStatus.isConnected ? 'å®æ—¶æ¨é€' : 'é™æ€æ˜¾ç¤º'}}</text>
        </view>
        <text class="section-more" bind:tap="navigateToAnnouncements">æŸ¥çœ‹æ›´å¤š</text>
      </view>
    </view>

    <!-- ğŸ”„ åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">ğŸ“¡ è¿æ¥å®æ—¶æ•°æ®æº...</text>
    </view>

    <!-- å…¬å‘Šåˆ—è¡¨ -->
    <view class="announcements-list" wx:if="{{!loading}}">
      <view class="announcement-item" 
            wx:for="{{announcements}}" 
            wx:key="id" 
            bind:tap="viewAnnouncement" 
            data-announcement="{{item}}">
        <view class="announcement-content">
          <view class="announcement-header">
            <text class="announcement-title">{{item.title}}</text>
            <view class="announcement-meta">
              <text class="announcement-department">{{item.department}}</text>
              <text class="announcement-time">{{item.date}} {{item.time}}</text>
            </view>
          </view>
          <text class="announcement-preview">{{item.content}}</text>
        </view>
        <view class="announcement-indicator">
          <view class="announcement-status new" wx:if="{{item.isNew}}">
            <text class="status-text">æ–°</text>
          </view>
          <view class="announcement-priority priority-{{item.priority}}"></view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{announcements.length === 0}}">
        <text class="empty-icon">ğŸ“­</text>
        <text class="empty-text">æš‚æ— å…¬å‘Š</text>
        <text class="empty-subtitle">å®æ—¶æ¨é€å°†åœ¨æœ‰æ–°å…¬å‘Šæ—¶è‡ªåŠ¨æ˜¾ç¤º</text>
      </view>
    </view>
  </view>

  <!-- ğŸ”¥ æµå¼ä½“éªŒå±•ç¤ºåŒºåŸŸ -->
  <view class="experience-section" wx:if="{{streamStatus.isConnected}}">
    <view class="section-header">
      <text class="section-title">âœ¨ æµå¼ä½“éªŒ</text>
      <text class="section-subtitle">æ„Ÿå—å®æ—¶æ•°æ®çš„é­…åŠ›</text>
    </view>
    
    <view class="experience-grid">
      <view class="experience-item">
        <view class="experience-icon">ğŸš€</view>
        <text class="experience-title">å®æ—¶æ¨é€</text>
        <text class="experience-desc">æ–°æ¶ˆæ¯å³æ—¶é€è¾¾</text>
      </view>
      
      <view class="experience-item">
        <view class="experience-icon">âš¡</view>
        <text class="experience-title">é›¶å»¶è¿Ÿ</text>
        <text class="experience-desc">æ•°æ®æ›´æ–°æ— éœ€ç­‰å¾…</text>
      </view>
      
      <view class="experience-item">
        <view class="experience-icon">ğŸ¯</view>
        <text class="experience-title">æ™ºèƒ½æ›´æ–°</text>
        <text class="experience-desc">åªæ¨é€ç›¸å…³å†…å®¹</text>
      </view>
      
      <view class="experience-item">
        <view class="experience-icon">ğŸ’š</view>
        <text class="experience-title">èŠ‚èƒ½é«˜æ•ˆ</text>
        <text class="experience-desc">ä½åŠŸè€—æµå¼ä¼ è¾“</text>
      </view>
    </view>
    
    <!-- ä½“éªŒç»Ÿè®¡ -->
    <view class="experience-stats">
      <view class="stat-item">
        <text class="stat-number">{{streamStatus.activeStreams}}</text>
        <text class="stat-label">æ´»è·ƒæ•°æ®æµ</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{newAnnouncementCount}}</text>
        <text class="stat-label">å®æ—¶æ¨é€æ¬¡æ•°</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">0</text>
        <text class="stat-label">å»¶è¿Ÿæ¯«ç§’</text>
      </view>
    </view>
  </view>

  <!-- ä¼ ç»Ÿ vs æµå¼å¯¹æ¯” -->
  <view class="comparison-section">
    <view class="section-header">
      <text class="section-title">ğŸ”„ ä½“éªŒå¯¹æ¯”</text>
      <text class="section-subtitle">ä¼ ç»Ÿæ–¹å¼ vs æµå¼å°è£…</text>
    </view>
    
    <view class="comparison-table">
      <view class="comparison-row header">
        <text class="comparison-cell">ç‰¹æ€§</text>
        <text class="comparison-cell">ä¼ ç»Ÿæ–¹å¼</text>
        <text class="comparison-cell">æµå¼å°è£…</text>
      </view>
      
      <view class="comparison-row">
        <text class="comparison-cell">æ•°æ®è·å–</text>
        <text class="comparison-cell traditional">ç‚¹å‡»-ç­‰å¾…-åŠ è½½</text>
        <text class="comparison-cell streaming">è‡ªåŠ¨-å®æ—¶-æ¨é€</text>
      </view>
      
      <view class="comparison-row">
        <text class="comparison-cell">ç”¨æˆ·ä½“éªŒ</text>
        <text class="comparison-cell traditional">è¢«åŠ¨åˆ·æ–°</text>
        <text class="comparison-cell streaming">ä¸»åŠ¨é€šçŸ¥</text>
      </view>
      
      <view class="comparison-row">
        <text class="comparison-cell">å“åº”é€Ÿåº¦</text>
        <text class="comparison-cell traditional">3-5ç§’</text>
        <text class="comparison-cell streaming">&lt; 0.1ç§’</text>
      </view>
    </view>
  </view>
</view>

<!-- ğŸŒŠ å…¨å±€æµå¼çŠ¶æ€æµ®åŠ¨æŒ‰é’® -->
<view class="floating-stream-button {{streamStatus.isConnected ? 'connected' : 'disconnected'}}" 
      bind:tap="testStreamConnection">
  <view class="float-icon">ğŸŒŠ</view>
  <view class="float-pulse {{streamStatus.isConnected ? 'active' : ''}}"></view>
</view>

<!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
<custom-navbar title="SZTU iCampus" show-back="{{false}}">
  <!-- ğŸ”— æµå¼è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
  <view slot="right" class="stream-indicator {{streamStatus.isConnected ? 'connected' : 'disconnected'}}" 
        bindtap="showDetailedStats">
    <text class="stream-dot {{streamStatus.isConnected ? 'pulse' : ''}}"></text>
    <text class="stream-text">{{streamStatus.isConnected ? 'å®æ—¶' : 'ç¦»çº¿'}}</text>
  </view>
</custom-navbar>

<view class="container">
  <!-- ğŸ® ä½“éªŒæ¨¡å¼æ§åˆ¶é¢æ¿ -->
  <view class="experience-panel {{demoMode ? 'active' : ''}}" wx:if="{{demoMode || streamStatus.isConnected}}">
    <view class="panel-header">
      <text class="panel-title">ğŸŒŠ æµå¼å°è£…ä½“éªŒä¸­å¿ƒ</text>
      <switch class="demo-switch" checked="{{demoMode}}" bindchange="toggleDemoMode" color="#0052d9"/>
    </view>
    
    <!-- ğŸ“Š å®æ—¶ç»Ÿè®¡ -->
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{streamStatus.connectionDuration || 0}}s</text>
        <text class="stat-label">è¿æ¥æ—¶é•¿</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{streamStatus.dataCount}}</text>
        <text class="stat-label">æ•°æ®æ¥æ”¶</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{streamStatus.cacheHitRate}}</text>
        <text class="stat-label">ç¼“å­˜å‘½ä¸­</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{experienceStats.realTimePushes}}</text>
        <text class="stat-label">å®æ—¶æ¨é€</text>
      </view>
    </view>
    
    <!-- ğŸ¯ ä½“éªŒæ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="action-btn primary" bindtap="showDetailedStats">
        ğŸ“Š è¯¦ç»†ç»Ÿè®¡
      </button>
      <button class="action-btn secondary" bindtap="testNetworkAdaptation">
        ğŸŒ ç½‘ç»œæµ‹è¯•
      </button>
      <button class="action-btn danger" bindtap="clearCacheExperience">
        ğŸ§¹ æ¸…ç†ç¼“å­˜
      </button>
    </view>
  </view>

  <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
  <view class="user-card">
    <view class="user-avatar">
      <image src="{{user.avatar}}" mode="aspectFill" />
    </view>
    <view class="user-info">
      <text class="user-name">{{user.name}}</text>
      <text class="user-id">{{user.studentId}}</text>
    </view>
    
    <!-- ğŸ”— æµå¼è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
    <view class="connection-status">
      <text class="status-badge {{streamStatus.isConnected ? 'online' : 'offline'}}">
        {{streamStatus.isConnected ? 'ğŸŒŠ å®æ—¶è¿æ¥' : 'ğŸ“´ ç¦»çº¿æ¨¡å¼'}}
      </text>
      <text class="last-update" wx:if="{{streamStatus.lastUpdate}}">
        æœ€åæ›´æ–°: {{streamStatus.lastUpdate}}
      </text>
    </view>
  </view>

  <!-- ğŸ¯ å¿«é€ŸåŠŸèƒ½å…¥å£ -->
  <view class="quick-actions">
    <view class="quick-action" bindtap="navigateToAnnouncements">
      <image src="assets/icons/notification.png" class="action-icon"/>
      <text class="action-text">æ ¡å›­å…¬å‘Š</text>
      <!-- ğŸ“¢ æ–°æ¨é€æç¤º -->
      <view class="push-badge" wx:if="{{experienceStats.realTimePushes > 0}}">
        {{experienceStats.realTimePushes}}
      </view>
    </view>
    
    <view class="quick-action" bindtap="navigateToSchedule">
      <image src="assets/icons/schedule.png" class="action-icon"/>
      <text class="action-text">è¯¾ç¨‹è¡¨</text>
    </view>
    
    <view class="quick-action" bindtap="navigateToEvents">
      <image src="assets/icons/event.png" class="action-icon"/>
      <text class="action-text">æ ¡å›­æ´»åŠ¨</text>
      <!-- ğŸ‘¥ å‚ä¸äººæ•°å˜åŒ–æç¤º -->
      <view class="activity-badge" wx:if="{{streamStatus.activeStreams > 1}}">
        å®æ—¶
      </view>
    </view>
    
    <view class="quick-action" bindtap="navigateToGrades">
      <image src="assets/icons/Grade.png" class="action-icon"/>
      <text class="action-text">æˆç»©æŸ¥è¯¢</text>
    </view>
  </view>

  <!-- ğŸ“¢ æœ€æ–°å…¬å‘Š - æ”¯æŒå®æ—¶æ¨é€ -->
  <view class="section">
    <view class="section-header">
      <text class="section-title">ğŸ“¢ æœ€æ–°å…¬å‘Š</text>
      <text class="section-more" bindtap="navigateToAnnouncements">æŸ¥çœ‹æ›´å¤š</text>
    </view>
    
    <view class="notices-list" wx:if="{{notices.length > 0}}">
      <view class="notice-item {{item.isNewPush ? 'new-push' : ''}}" 
            wx:for="{{notices}}" 
            wx:key="id"
            bindtap="viewAnnouncement" 
            data-announcement="{{item}}">
        <!-- ğŸŒŠ æ–°æ¨é€æ ‡è¯† -->
        <view class="new-push-indicator" wx:if="{{item.isNewPush}}">
          <text class="pulse-text">ğŸ”¥ å®æ—¶æ¨é€</text>
        </view>
        
        <view class="notice-content">
          <text class="notice-title">{{item.title}}</text>
          <text class="notice-department">{{item.department}}</text>
          <text class="notice-time">{{item.created_at}}</text>
        </view>
        
        <!-- ğŸ“Š æ•°æ®æ¥æºæ ‡è¯† -->
        <view class="source-badge">
          <text wx:if="{{item.stream_type === 'realtime_push'}}" class="source-tag realtime">ğŸŒŠ å®æ—¶</text>
          <text wx:elif="{{item.isOfflineData}}" class="source-tag offline">ğŸ“¦ ç¼“å­˜</text>
          <text wx:else class="source-tag normal">ğŸ“¡ å¸¸è§„</text>
        </view>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:else>
      <text class="empty-text">{{loadingNotices ? 'ğŸ”„ è¿æ¥å®æ—¶æ•°æ®ä¸­...' : 'æš‚æ— å…¬å‘Š'}}</text>
    </view>
  </view>

  <!-- ğŸ¯ è¿‘æœŸæ´»åŠ¨ -->
  <view class="section">
    <view class="section-header">
      <text class="section-title">ğŸ¯ è¿‘æœŸæ´»åŠ¨</text>
      <text class="section-more" bindtap="navigateToEvents">æŸ¥çœ‹æ›´å¤š</text>
    </view>
    
    <view class="events-list" wx:if="{{recentEvents.length > 0}}">
      <view class="event-item" wx:for="{{recentEvents}}" wx:key="id" bindtap="viewEvent" data-event="{{item}}">
        <view class="event-info">
          <text class="event-title">{{item.title}}</text>
          <text class="event-time">{{item.event_date}}</text>
          <text class="event-location">ğŸ“ {{item.location}}</text>
          
          <!-- ğŸ‘¥ å®æ—¶å‚ä¸äººæ•° -->
          <view class="participants-info" wx:if="{{item.current_participants != null}}">
            <text class="participants-count">
              ğŸ‘¥ {{item.current_participants}}/{{item.max_participants}}
            </text>
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{(item.current_participants / item.max_participants * 100)}}%"></view>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <view class="empty-state" wx:else>
      <text class="empty-text">æš‚æ— æ´»åŠ¨</text>
    </view>
  </view>
</view> 