# SZTU-iCampus 智慧校园系统
1233213
## 🎯 项目概述

深圳技术大学智慧校园微信小程序，采用**前端-后端-数据库三层分离架构**，提供校园内各种Web服务的统一入口。利用流式处理技术实时加载内容，保证数据安全性和隐私性，同时不占用服务器存储资源。

### 核心功能
- **认证模块**：微信小程序登录、JWT认证
- **课表查询**：个人课程表、课程详情、课程变更通知
- **校园公告**：学校公告、部门通知、实时推送
- **成绩查询**：个人成绩、成绩统计、新成绩通知
- **考试管理**：考试安排、考试倒计时、考试提醒
- **图书馆服务**：图书检索、借阅记录、座位预约、到期提醒
- **校园卡管理**：余额查询、消费记录、实时交易通知
- **活动日历**：校园活动、报名参与、签到统计

## 🏗️ 架构设计

### 三层分离架构
```
微信小程序前端 (Port: 小程序)
        ↕ HTTP/HTTPS
胶水层后端 (Port: 8000) - FastAPI
        ↕ HTTP + API Key认证
数据服务层 (Port: 8001) - FastAPI + SQLite
```

### 核心优势
- ✅ **真实数据流**：前端 → 胶水层 → 数据服务 → SQLite数据库
- ✅ **无模拟数据**：所有数据都从数据库真实获取
- ✅ **安全隔离**：数据服务与外网隔离，通过API Key认证
- ✅ **流式推送**：实时监控数据变化，推送到前端
- ✅ **离线支持**：缓存机制确保离线也能查看数据

## 🚀 快速开始

### 环境要求
- Python 3.8+
- Node.js 14+
- 微信开发者工具

### 1. 启动数据服务（必须先启动）
```bash
cd data-service
conda activate icamp
pip install -r requirements.txt
python main.py
```
**访问地址**: http://127.0.0.1:8001
**API文档**: http://127.0.0.1:8001/docs

### 2. 启动胶水层后端
```bash
cd backend
conda activate icamp
pip install -r requirements.txt
uvicorn main:app --reload
```
**访问地址**: http://127.0.0.1:8000
**API文档**: http://127.0.0.1:8000/api/v1/docs

### 3. 启动微信小程序
1. 用微信开发者工具打开 `miniprogram` 目录
2. 确保后端服务正常运行
3. 点击编译运行

### 测试账号
- **管理员账号**: `2025000001` / `Admin001HP1dbd10`
- **学生账号**: `2021000432` / `Stu002SW2ac08`

## 📊 流式推送系统

### 实时事件类型
- `announcement`: 新公告发布
- `grade_update`: 成绩更新
- `transaction`: 校园卡消费
- `library_reminder`: 图书到期提醒
- `course_change`: 课程变更

### 推送机制
1. **后端监控**：EventManager定时检查数据变化
2. **事件发布**：检测到变化时推送事件到队列
3. **前端轮询**：长轮询模式获取最新事件（10秒间隔）
4. **缓存同步**：增量更新本地缓存
5. **离线支持**：网络恢复时自动同步

### 缓存策略
- **公告缓存**：最近100条
- **成绩缓存**：按学期组织
- **交易缓存**：最近200条
- **事件缓存**：最近300个事件

## 🔒 安全机制

### 通信安全
- **JWT认证**：所有个人数据接口需要token
- **API密钥**：胶水层与数据服务间使用固定密钥
- **数据隔离**：数据服务不直接暴露给外网
- **权限控制**：不同角色的数据访问权限

### 数据安全
- **敏感信息脱敏**：手机号、身份证号自动脱敏
- **本地存储加密**：小程序本地缓存安全存储
- **请求日志**：完整的API请求日志记录

## 📖 API文档说明

### 胶水层API (Port: 8000)
**完整文档**: http://127.0.0.1:8000/api/v1/docs

核心端点：
- `POST /api/v1/auth/login` - 用户登录
- `GET /api/v1/schedule/current-week` - 获取当前周课表
- `GET /api/v1/announcements` - 获取公告列表
- `GET /api/v1/grades` - 获取成绩信息
- `GET /api/v1/stream/sync` - 增量事件同步

### 数据服务API (Port: 8001)
**完整文档**: http://127.0.0.1:8001/docs

核心端点：
- `GET /query/{table_name}` - 通用数据查询
- `POST /auth/login` - 用户认证
- `GET /announcements` - 公告数据
- `GET /grades/student/{student_id}` - 学生成绩

## 🛠️ 开发指南

### 添加新功能
1. **设计数据表**：在数据服务层定义数据结构
2. **实现API**：在胶水层创建对应的API端点
3. **前端调用**：在小程序中调用API并处理数据
4. **添加推送**：如需实时推送，在EventManager中添加监控

### 调试流程
1. **查看日志**：
   - 数据服务：`data-service/logs/`
   - 胶水层：`backend/logs/`
   - 前端：微信开发者工具控制台

2. **测试API**：
   - 数据服务API: http://127.0.0.1:8001/docs
   - 胶水层API: http://127.0.0.1:8000/api/v1/docs

3. **检查数据库**：数据存储在 `data-service/sztu_campus.db`

### 常见问题
1. **401/403错误**：检查token是否有效，重新登录
2. **连接失败**：确保后端服务启动，检查端口占用
3. **数据为空**：检查数据库是否初始化，执行mock数据生成

## 📈 性能优化

### 缓存策略
- **前端缓存**：减少重复API请求
- **增量同步**：只传输变化的数据
- **分页加载**：大数据集分页获取

### 流式优化
- **长轮询**：适配微信小程序的推送机制
- **智能间隔**：根据网络状态调整轮询频率
- **断线重连**：网络异常时自动重连

## 🔧 维护说明

### 日常运维
- **日志轮转**：自动清理过期日志
- **数据备份**：定期备份SQLite数据库
- **性能监控**：监控API响应时间

### 故障排查
1. **检查服务状态**：
   ```bash
   # 数据服务健康检查
   curl http://127.0.0.1:8001/health
   
   # 胶水层健康检查  
   curl http://127.0.0.1:8000/health
   ```

2. **重启服务**：
   ```bash
   # 重启数据服务
   cd data-service && python main.py
   
   # 重启胶水层
   cd backend && uvicorn main:app --reload
   ```

## 🎉 项目亮点

### 技术亮点
- ✅ **三层架构分离**：完全模拟生产环境
- ✅ **流式数据推送**：实时同步数据变化
- ✅ **RESTful API设计**：规范统一的接口设计
- ✅ **JWT安全认证**：完整的用户认证体系
- ✅ **离线缓存支持**：优秀的用户体验

### 功能亮点
- ✅ **5+1核心功能**：覆盖校园生活主要场景
- ✅ **实时通知推送**：重要事件及时提醒
- ✅ **数据安全保护**：敏感信息自动脱敏
- ✅ **跨平台兼容**：微信小程序生态完整支持

### 工程亮点
- ✅ **无模拟数据**：完全真实的数据流
- ✅ **完整的文档**：API文档、使用文档齐全
- ✅ **可扩展架构**：易于添加新功能
- ✅ **生产级部署**：支持水平扩展和负载均衡

---

**开发团队**: SZTU-iCampus 项目组  
**技术栈**: FastAPI + SQLite + 微信小程序 + SSE  
**版本**: v1.0.0 