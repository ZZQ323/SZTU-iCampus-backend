<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册页面</title>
    <link rel="stylesheet" href="/static/css/register.css">
    <script src="/static/js/common.js"></script>
</head>
<body>
    <button class="goback" onclick="goto('index.html')">返回主页</button>
    <div class="register-container">
        <!-- 步骤导航 -->
        <ol class="step-nav" onclick="chooseStep()">
            <li class="active"><a href="#step1">验证手机号</a></li>
            <li>===></li>
            <li><a href="#step2">填写账号信息</a></li>
            <li>===></li>
            <li><a href="#step3">注册成功</a></li>
        </ol>

        <!-- 第一步：验证手机号 -->
        <div id="step1" class="step-content active">
            <div class="form-group">
                <input type="tel" id="phone"  name="phone" placeholder="请输入手机号" required>
            </div>
            <button class="btn btn-verify">点击按钮进行验证</button>
            <button class="btn btn-next" onclick="nextStep()">下一步</button>
        </div>

        <!-- 第二步：填写账号信息 -->
        <div id="step2" class="step-content">
            <div class="form-group">
                <input type="text" placeholder="账号名（长度保证在6位-16位长度，可以由任意字母字符数字构成）" required>
            </div>
            <div class="form-group">
                <input type="password" placeholder="设置密码（长度保证在8位-16位长度，可以由大小写字母数字_@构成）" required>
            </div>
            <div class="form-group">
                <input type="password" placeholder="确认密码" required>
            </div>
            <div class="form-group">
                <input id="emailInput" type="email" placeholder="邮箱验证" required>
            </div>
            <div class="form-group">
                <input type="text" id="codeInput" placeholder="邮箱验证码" required>
                <button id="sendCodeBtn" class="btn btn-verify" style="margin-top: 5px;">获取验证码</button>
            </div>
            <button class="btn btn-register" onclick="nextStep()">立即注册</button>
        </div>

        <!-- 第三步：注册成功 -->
        <div id="step3" class="step-content">
            <h2 style="color: #4CAF50; text-align: center;">恭喜您注册成功！</h2>
        </div>
    </div>

    <script>
        let step = 1;
        // 添加验证码相关变量
        // 绑定发送验证码按钮事件
        let emailCode = ''; // 存储服务端返回的验证码
        let codeTimer = null;

        {
            document.getElementById('sendCodeBtn')
            .addEventListener('click', async function() {
                const email = document.getElementById('emailInput').value.trim();

                // 禁用按钮并开始倒计时
                this.disabled = true;
                // const temp = document.querySelectorAll("#step2 .form-group")[3].children[0].value;
                console.log(this);
                //console.log(this===temp); // false

                let count = 60;
                const timerText = () => `${count}秒后重新获取`;
                this.textContent = timerText();

                codeTimer = setInterval(() => {
                    count--;
                    this.textContent = timerText();
                    if (count <= 0) {
                        clearInterval(codeTimer);
                        this.disabled = false;
                        this.textContent = '获取验证码';
                    }
                }, 1000);

                try {
                    // 发送请求到后端
                    const response = await fetch('http://localhost:3000/api/send-code', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });

                    const data = await response.json();
                    if (data.success) {
                        emailCode = data.code; // 存储验证码用于后续验证
                        alert('验证码已发送，请注意查收');
                    } else {
                        alert('发送失败：' + data.message);
                        clearInterval(codeTimer);
                        this.disabled = false;
                        this.textContent = '获取验证码';
                    }
                } catch (error) {
                    alert('网络错误，请重试');
                    clearInterval(codeTimer);
                    this.disabled = false;
                    this.textContent = '获取验证码';
                }
            });
        }

        function nextStep(){
            // console.log(inputt);
            // console.log(inputt.name);
            if(step===1){
                const reg = /^[1][3-9][0-9]{9,11}$/gmi;
                let inputt = document.getElementById("phone");
                //console.log(reg.test(name));
                if(!reg.test(inputt.value)){
                    alert("手机号格式不正确！请重新输入。");
                    return;
                }
            }
            if(step===2){
                // [\s]表示，只要出现空白就匹配
                // [\S]表示，非空白就匹配
                const usernameReg  = /\S{6,16}/gmi;
                // const passwordReg  = /[a-zA-Z_@]{8,16}/gmi;
                const passwordReg  = /^[\w@]{8,16}$/i
                const emailReg  = /^([A-Za-z0-9_\-\.])+@([A-Za-z0-9_\-\.])+\.[A-Za-z]{2,4}$/gmi;
                const parent = document.querySelectorAll("#step2 .form-group");
                // console.log(parent);
                const name = parent[0].children[0].value;
                const psd = parent[1].children[0].value;
                const comPsd = parent[2].children[0].value;
                const eml = parent[3].children[0].value;
                const comEml = parent[4].children[0].value;
                // console.log(name);
                // console.log(psd);
                // console.log(comPsd);
                // console.log(eml);
                // console.log(comEml);
                if(!usernameReg.test(name)){alert("用户名长度不正确！请重新输入。");return;}
                if(!passwordReg.test(psd)){alert("密码不正确！请重新输入。");return;}
                if(psd!==comPsd){alert("确认密码的与前一次输入的不一致！请重新输入。");return;}
                if(!emailReg.test(eml)){alert("邮箱格式不正确！请重新输入。");return;}

                // 验证码验证
                const emailCode = getEmailValidation(eml.trim());
                const inputCode = document.getElementById('codeInput').value.trim();
                if(inputCode !== emailCode.toString()){ // 实际项目应查询数据库验证
                    alert("验证码错误！请重新输入。");
                    return;
                }
            }
            ++step;
            showStep();
        }
        

        function chooseStep(e){
            const cur = e.currentTarget;
            console.log(cur);
            // console.log(cur);
        }

        // 步骤切换逻辑
        function showStep() {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.step-nav li').forEach(el => el.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active'); // 显示对象
            let nodes = document.querySelectorAll('.step-nav li'); // 
            for(let i = 0;i<nodes.length;++i){
                if(i === (step<<1)-1 )break;
                nodes[i].classList.add('active');
            }
        }

        // 表单验证逻辑
        function validateForm() {
            const inputs = document.querySelectorAll('#step2 input');
            let isValid = true;
            inputs.forEach(input => {
                if (!input.value.trim()) isValid = false;
            });
            if (isValid) showStep(3);
            else alert('请填写所有必填字段！');
        }
    </script>
</body>
</html>